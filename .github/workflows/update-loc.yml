# Add this file to .github/workflows/update-loc.yml
on:
  push:
    branches:
      - main

name: Update Lines of Code in README
permissions:
  contents: write

jobs:
  count-lines:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          persist-credentials: true

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq cloc locales
          sudo locale-gen en_US.UTF-8

      - name: Run cloc and save JSON
        run: |
          mkdir -p output
          # analyze the repository and exclude typical non-source extensions
          cloc . --json --out=output/cloc-output.json --exclude-ext=html,htm,css,json,md,markdown,xml,svg,scss,yaml,toml,csv,txt,yml,sass,lock,log,properties

      - name: Update README with LOC block
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          TOTAL_LINES=$(jq '.SUM.code // 0' output/cloc-output.json)

          format_number() {
            export LC_ALL="en_US.UTF-8"
            printf "%'d\n" $1
          }

          LANG_BREAKDOWN=$(jq -r 'to_entries
            | map(select(.key != "header" and .key != "SUM"))
            | map({lang: .key, lines: .value.code})
            | map(select(.lines > 1))
            | sort_by(-.lines)[]
            | "\(.lang),\(.lines)"' output/cloc-output.json)

          FORMATTED_BREAKDOWN=""
          while IFS=, read -r LANG LINES; do
            FORMATTED=$(format_number $LINES)
            FORMATTED_BREAKDOWN+=$(printf "%-15s --> %10s lines\n" "$LANG" "$FORMATTED")$'\n'
          done <<< "$LANG_BREAKDOWN"

          FORMATTED_TOTAL=$(format_number $TOTAL_LINES)

          CODE_BLOCK="\`\`\`
[ LANGUAGES BREAKDOWN ]

$FORMATTED_BREAKDOWN
[ TOTAL LINES OF CODE: $FORMATTED_TOTAL ]
\`\`\`"

          # Ensure your README has the two marker comments shown below
          echo "$CODE_BLOCK" > temp_block.txt
          sed -i '/<!-- LANGUAGES BREAKDOWN START -->/,/<!-- LANGUAGES BREAKDOWN END -->/{
              //!d
              /<!-- LANGUAGES BREAKDOWN START -->/r temp_block.txt
          }' README.md
          rm temp_block.txt

          git add output/cloc-output.json README.md || true
          git commit -m "Update README with latest LOC" || echo "No changes to commit"
          git push origin HEAD:main
